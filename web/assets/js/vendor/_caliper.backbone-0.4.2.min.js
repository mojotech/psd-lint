/* Backbone adapter for caliper.js v0.4.2 (c) 2013 Coherence Inc (https://github.com/caliper-io/caliper-backbone) */
!function(a,b,c){!function(){"use strict";var a={VERSION:"0.2.1"},b=window.Caliper||{};if(b.loaded===!0){var c;return a.VERSION===b.VERSION?(c="Already loaded caliper.core  v"+a.VERSION,b.config&&b.config.debug===!0&&("function"==typeof b.warn?b.warn(c):window.console&&"function"==typeof window.console.warn?window.console.warn("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **WARNNING** "+c))):(c="Failed to load caliper.core  v"+a.VERSION+": "+"another version of caliper.core (v"+b.VERSION+") was already loaded","function"==typeof b.error?b.error(c):window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **ERROR** "+c)),void 0}a.config={apiKey:null,beaconURL:"//b.caliper.io/_.gif",debug:!1,enabled:!0};for(var d in b.config)b.config.hasOwnProperty(d)&&(a.config[d]=b.config[d]);var e=function(){return!!(!window.attachEvent||window.addEventListener||window.navigator.userAgent.indexOf("MSIE 8.0")>=0)}();if(a.enabled=!(!e||!a.config.enabled),a.enabled===!1)return a.debug&&window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] Caliper is disabled"),window.Caliper=a,void 0;if(Date.now||(Date.now=function(){return(new Date).valueOf()}),a.__empty__=function(){},a.log=window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] "+b)}:a.__empty__,a.warn=window.console&&"function"==typeof window.console.warn?function(b){a.config.debug===!0&&window.console.warn("[Caliper] "+b)}:window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] **WARNNING** "+b)}:a.__empty__,a.error=window.console&&"function"==typeof window.console.error?function(a){window.console.error("[Caliper] "+a)}:window.console&&"function"==typeof window.console.log?function(a){window.console.log("[Caliper] **ERROR** "+a)}:a.__empty__,a.slice=function(a){return Array.prototype.slice.call(a)},a.setImmediate="function"==typeof window.setImmediate?function(){return window.setImmediate.apply(window,arguments)}:function(a){var b=[].slice.call(arguments,1);return window.setTimeout(function(){a.apply(null,b)},0)},a.randomStr=function(a){var b=a.length;return function(c){for(var d=[],e=0;c>e;e++)d.push(a[Math.floor(Math.random()*b)]);return d.join("")}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),a.__super__=function(){throw new Error("Cannot call Caliper.__super__ outside of a wrapped function")},a.wrap=function(b,c){return function(){var d=a.__super__,e=this,f=a.slice(arguments);try{return a.__super__="function"==typeof b?function(){return this===a?0===arguments.length?b.apply(e,f):b.apply(e,arguments):b.apply(this,arguments)}:a.__empty__,c.apply(this,arguments)}finally{a.__super__=d}}},a.aliasMethodChain=function(a,b,c,d){var e=a[b];if("function"==typeof e){var f="__"+b+"_without_"+c+"__",g="__"+b+"_with_"+c+"__";a[f]=e,a[g]=a[b]=d}return a},a.nameFor=function(a){return"string"==typeof a||a instanceof String?a:a&&a.constructor?a.__name__||a.constructor.__name__:void 0},a.log("Initializing caliper.core v"+a.VERSION+"..."),!a.config.apiKey||!a.config.apiKey.length)return a.error("Failed to load caliper.core: did you forget to set your Caliper API key?"),window.Caliper=a,void 0;a.sessionID=a.randomStr(16),a.log("Generated session ID "+a.sessionID),a.visitorID=a.config.visitor||function(){var b,c=function(){for(var a="_cpv=",b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].replace(/^\s+|\s+$/g,""),e=d.indexOf(a);if(0===e)return d.substring(5,d.length)}return void 0},d=function(a){var b=new Date(Date.now()+631152e5);return document.cookie="_cpv="+a+"; expires="+b.toGMTString()+"; path=/",a};return b=c(),b?a.log("Using existing visitor ID "+b):(b=a.randomStr(16),a.log("Generated visitor ID "+b)),d(b)}();var f=0,g=function(a){"string"==typeof a&&(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(encodeURIComponent(a[c]).replace(/[-_~%]/g,function(a){switch(a){case"-":return"~2D";case"_":return"~5F";case"~":return"~7E";case"%":return"~"}}));return b.join("-")},h=function(a){if("string"==typeof a)return g(a);for(var b=[],c=0;c<a.length;c++)b.push(g(a[c]));return b.join("_")},i=function(a){for(var b in a)return!1;return!0};a.send=function(b,c){if(!a.config.apiKey||!a.config.apiKey.length)return a.error("Attempted to call send without an API key set, payload dropped"),void 0;if(b&&b.length>0||c&&!i(c)){var d={},e=[];for(var g in a.adapters)a.adapters.hasOwnProperty(g)&&e.push(g+"-"+a.adapters[g].VERSION);d.k=a.config.apiKey,d.c=e.join("_"),d.s=a.sessionID,a.config.visitor?d.e=encodeURIComponent(a.config.visitor):d.v=encodeURIComponent(a.visitorID);var j=[];for(var k in d)d.hasOwnProperty(k)&&j.push(k+"="+d[k]);for(k in c)c.hasOwnProperty(k)&&j.push(k+"="+encodeURIComponent(c[k]));var l=f++,m=a.config.beaconURL+"?"+j.join("&");b&&(m=m+"&p="+h(b)),a.log("Sending request "+l),m.length>2e3&&a.log("Request "+l+": URL is "+m.length+" characters long, this might cause errors in some browsers!");var n=function(){a.log("Completed request "+l)},o=function(){a.log("Failed request "+l+", giving up")},p=function(b,c,d){return function(){a.log("Failed request "+l+", retrying in "+b+" seconds"),window.setTimeout(function(){a.log("Retrying request "+l),d>0?a.dispatchRequest(m,n,p(b*c,c,d-1)):a.dispatchRequest(m,n,o)},1e3*b)}};a.dispatchRequest(m,n,p(30,2,2))}},a.dispatchRequest=function(a,b,c){var d=new Image;"function"==typeof b&&(d.onload=b),"function"==typeof c&&(d.onerror=c),d.src=a},a.adapters={core:a},a.loaded=!0,window.Caliper=a,a.log("Sucessfully loaded caliper.core v"+a.VERSION)}(),function(a,b,c,d){"use strict";var e={VERSION:"0.4.2"};if(void 0===a||a.loaded!==!0)a&&a.enabled!==!1&&(window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] Failed to load caliper.backbone: caliper.core could not be found"):window.console&&"function"==typeof window.console.log&&window.console.error("[Caliper] **ERROR** Failed to load caliper.backbone: caliper.core could not be found"));else if(a.adapters&&a.adapters.Backbone)a.adapters.Backbone.VERSION===e.VERSION?a.warn("Already loaded caliper.backbone v"+e.VERSION):a.error("Failed to load caliper.backbone v"+e.VERSION+": "+"another version of caliper.backbone (v"+a.adapters.Backbone.VERSION+") was already loaded");else if(void 0===b)a.error("Failed to load caliper.backbone: Backbone could not be found");else if(void 0===c)a.error("Failed to load caliper.backbone: Underscore could not be found");else{a.log("Initializing caiper.backbone v"+e.VERSION),void 0===a.config.enableAjaxFilter&&a.config.disableAjaxFilter===!1&&(a.config.enableAjaxFilter=!0),a.config.enableAjaxFilter=a.config.enableAjaxFilter||!1,a.config.minDuration=a.config.minDuration||50;var f=c.result||function(a,b){if(!a)return null;var d=a[b];return c.isFunction(d)?d.call(a):d},g=a.wrap(a.aliasMethodChain,function(b,d,e,f){var g=b[d];if("function"!=typeof g)return b;var h=a.wrap(g,f);return h="function"==typeof g.extend?g.extend({constructor:h}):c.extend(h,g),a.__super__(b,d,e,h)});a.aliasMethodChain(a,"aliasMethodChain","underscore",g),a.aliasMethodChain(a,"nameFor","backbone",function(c){var d=a.__super__();return!d&&c instanceof b.View&&(d="UnnamedView",c.id?d=d+"<#"+f(c,"id")+">":c.className&&(d=d+"<."+f(c,"className")+">"),c.__name__=d),d});var h=function(a,b){this.method=a,this.url=b,this.startTime=Date.now(),this.pending=!0};h.prototype.stop=function(){this.pending&&(this.stopTime=Date.now(),this.pending=!1)},h.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["a",this.method,this.url,this.startTime-a,this.stopTime-this.startTime]):void 0};var i=function(a){this.viewName=a,this.startTime=Date.now(),this.pending=!0};i.prototype.stop=h.prototype.stop,i.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["r",this.viewName,this.startTime-a,this.stopTime-this.startTime]):void 0};var j=[],k=function(){return j[j.length-1]},l=function(a,b,c){this.klass=a,this.method=b,this.pattern=c,this.startTime=Date.now(),this.events=[],this.finalized=!1,j.push(this)};l.prototype.finalize=function(){if(this.finalized!==!0){var c;for(c=1;c<=j.length;c++)j[j.length-c]===this&&j.splice(j.length-c,1);for(c=0;c<this.events.length;c++)if(this.events[c].pending)return;if(this.stopTime=Date.now(),this.finalized=!0,this.duration=this.stopTime-this.startTime,this.duration<(a.config.minDuration||1))return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (minDuration is "+a.config.minDuration+"ms)"),void 0;if(a.config.enableAjaxFilter===!0){var d=!1;for(c=0;c<this.events.length;c++)if(this.events[c]instanceof h){d=!0;break}if(!d)return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (enableAjaxFilter is true)"),void 0}a.log("Sending: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms.");try{this.url=b.history.getFragment()}catch(e){this.url=window.location.hash.length?window.location.hash.substr(1):window.location.pathname}var f={bs:this.startTime,bd:this.duration,bu:this.url};this.klass&&this.klass.length>0&&(f.bc=this.klass),this.method&&this.method.length>0&&(f.bm=this.method),this.pattern&&this.pattern.length>0&&(f.bp=this.pattern);var g=[];for(c=0;c<this.events.length;c++)g.push(this.events[c].serialize(this.startTime));a.send(g,f)}},void 0!==b.Router&&a.aliasMethodChain(b,"Router","instrumentation",function(){return a.aliasMethodChain(this,"route","instrumentation",function(){var b=a.slice(arguments),c=String(b[0]),d=b[1],e=b[2];return"/"!==c[0]&&"!"!==c[0]&&(c="/"+c),"function"==typeof d?(e=d,d=void 0):void 0===e&&(e=this[d]),e=a.wrap(e,function(){var b=k();return b?(b.klass=a.nameFor(this),b.method=d,b.pattern=c):b=new l(a.nameFor(this),d,c),a.setImmediate(function(){b.finalize()}),a.__super__()}),a.__super__.call(this,b[0],d||"",e)}),a.__super__()}),void 0!==b.View&&a.aliasMethodChain(b,"View","instrumentation",function(){a.aliasMethodChain(this,"initialize","instrumentation",function(){var b;return k()||(b=new l(a.nameFor(this),"initialize"),a.setImmediate(function(){b.finalize()})),a.__super__()}),a.aliasMethodChain(this,"render","instrumentation",function(){var b,c=k();c&&(b=new i(a.nameFor(this)),c.events.push(b));var d=a.__super__();return b&&b.stop(),d});var b=function(b,c){return a.wrap(b,function(){if(!k()){var b=new l(a.nameFor(this),c);a.setImmediate(function(){b.finalize()})}return a.__super__()})};return a.aliasMethodChain(this,"delegateEvents","instrumentation",function(){var d,e,g=a.slice(arguments),h=c.clone(g[0]||f(this,"events"));for(var i in h)if(h.hasOwnProperty(i)){if(e=h[i],c.isFunction(e)?d="UnnamedAction":(d=e,e=this[e]),!e)continue;h[i]=b(e,d)}return a.__super__(h)}),a.__super__()}),a.aliasMethodChain(d,"ajax","instrumentation",function(){var b=k();if(b){var c=arguments[1]||arguments[0],d=c.type||"GET",e=c.url||arguments[0];"string"==typeof c&&(c={});var f=new h(d,e);return b.events.push(f),c.success=a.wrap(c.success,function(){return k()!==b&&j.push(b),f.stop(),a.__super__()}),c.error=a.wrap(c.error,function(){return k()!==b&&j.push(b),f.stop(),a.__super__()}),c.complete=a.wrap(c.complete,function(){return a.setImmediate(function(){b.finalize()}),a.__super__()}),c.url=e,a.__super__(c)}return a.__super__()}),b.history=b.history||new b.History,a.adapters.Backbone=e,a.log("Sucessfully loaded caliper.backbone v"+e.VERSION)}}(window.Caliper,a,b,c)}(window.Backbone,window._,window.jQuery||window.Zepto);